name: Publish

on:
    push:
        branches: [master]
    workflow_dispatch:

env:
    RELEASE_NAME: Kami.Sdk

jobs:
    publish:
        runs-on: self-hosted

        steps:
        - name: ⬇️ Checkout repository
          uses: actions/checkout@v3
          with:
            fetch-depth: 0 # avoid shallow clone so nbgv can do its work

        - name: ⚙️ Set up Dotnet Core
          uses: actions/setup-dotnet@v2
          with:
            dotnet-version: 6.0.x

        # - name: Bump package version
        #   uses: dotnet/nbgv@v0.4
        #   id: nbgv

        - name: Install and calculate the new version with GitVersion 
          uses: gittools/actions/gitversion/setup@v0.10.2
          with:
            versionSpec: 5.x
    
        - name: Determine Version
          uses: gittools/actions/gitversion/execute@v0.10.2
          id: gitversion # step id used as reference for output values
    
        - name: Display GitVersion outputs
          run: |
            echo "Version: ${{ steps.gitversion.outputs.SemVer }}"
            echo "CommitsSinceVersionSource: ${{ steps.gitversion.outputs.CommitsSinceVersionSource }}"
    
        - name: Setup GitHub Packages
          run: dotnet nuget add source --username oncoursesystems --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/oncoursesystems/index.json"

        - name: Pack
          run: dotnet pack -c Release -p:Version='${{ steps.gitversion.outputs.SemVer }}' -i . 

        - name: Publish to GitHub Packages
          run: dotnet nuget push *.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source "github"

        - name: Create release
          uses: actions/create-release@v1
          env: 
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            tag_name: v${{ steps.gitversion.outputs.SemVer }}
            release_name: ${{ env.RELEASE_NAME }} ${{ steps.gitversion.outputs.SemVer }}
            draft: false
            prerelease: false
