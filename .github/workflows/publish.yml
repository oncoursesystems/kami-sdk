name: Publish Package and Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  prepare_release:
    name: Prepare Release
    runs-on: self-hosted

    steps:
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          prerelease: true

  publish_package:
    name: Publish Package
    needs: [prepare_release]
    runs-on: self-hosted
    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v3

      - name: ⚙️ Set up Dotnet Core
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: 6.0.x
        env:
          DOTNET_INSTALL_DIR: "./.dotnet"

      - name: ⚙️ Setup GitHub Packages
        run: dotnet nuget add source --username oncoursesystems --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/oncoursesystems/index.json"

      - name: 📦 Pack project
        run: dotnet pack -c Release -p:Version='{{ github.ref_name }}'

      - name: 🚀 Publish to GitHub Packages
        run: dotnet nuget push bin/Release/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source "github"

  publish_release:
    name: Publish Release
    runs-on: self-hosted
    needs: [publish_package]
    steps:
      - name: 📝 Create changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          commitMode: true

      - name: 🚀 Release
        uses: softprops/action-gh-release@v1
        with:
          prerelease: false
          body: ${{ steps.build_changelog.outputs.changelog }}
